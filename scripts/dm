#!/bin/bash

case "${1:-menu}" in
    menu)
        cmd=$(echo -e "ps\npsa\npsi\nrm\nimg\nrmi\nup\nupb\nreup\ndown\ndown-v\nrestart\nnuke\niup\nidown\nvol\nbuild\npull\nservices\nsh\nilogs\ncheck\ncheck-yaml\ninspect\nheal\nrecreate\nexit" | gum choose --header "Docker iÅŸlemi:")
        [[ $cmd ]] && exec "$0" "$cmd"
        # menuden Ã§Ä±kmasÄ±n istersen
        # while true; do
        #     cmd=$(echo -e "ps\npsa\npsi\nrm\nimg\nlogs\nexit" | gum choose --header "Docker iÅŸlemi:")
        #     [[ $cmd == "exit" ]] && break
        #     "$0" "$cmd"
        # done
        ;;

    ps)
        echo "ğŸ“Š Ã‡alÄ±ÅŸan containerlar:"
        docker ps --format "table {{.ID}}\t{{.Status}}\t{{.Names}}\t{{.Ports}}"
        ;;

    psa)
        echo "ğŸ“‹ TÃ¼m containerlar:"
        docker ps -a --format "table {{.ID}}\t{{.Status}}\t{{.Names}}\t{{.Ports}}"
        ;;

    psi)
        echo "ğŸ“‹ TÃ¼m containerlar ID'li:"
        docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"
        ;;

    rm)
        echo "ğŸ›‘ KaldÄ±rÄ±lacak container'lar listeleniyor..."
        list=$(docker ps -a --filter label=com.docker.compose.project --format "{{.Names}}@{{.Status}}" | sort -u)  # Names kullan, service deÄŸil
        if [[ -z $list ]]; then
            echo "âŒ Ã‡alÄ±ÅŸan container yok!"
            exit 1
        fi
        formatted=$(echo "$list" | sed 's/@Up.*/ âœ… Running/' | sed 's/@Exited.*/ âŒ Stopped/' | sed 's/@Created.*/ ğŸŸ¡ Created/')
        selected=$(echo "$formatted" | gum choose --no-limit --header "KaldÄ±rÄ±lacak container'lar:")
        if [[ -n $selected ]]; then
            while IFS= read -r item; do
                [[ -z $item ]] && continue
                container=$(echo "$item" | cut -d' ' -f1)
                echo "ğŸ›‘ $container durduruluyor..."
                docker stop "$container"
                echo "ğŸ—‘ï¸ $container kaldÄ±rÄ±lÄ±yor..."
                docker rm -f "$container"
            done <<< "$selected"
            echo "âœ… SeÃ§ilen container'lar durduruldu ve kaldÄ±rÄ±ldÄ±"
        else
            echo "âŒ HiÃ§bir container seÃ§ilmedi"
        fi
        ;;

    img)
        echo "ğŸ“‹ TÃ¼m image'lar listeleniyor:"
        docker images --format "table {{.ID}}\t{{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
        ;;

    rmi)
        echo "ğŸ—‘ï¸ Silinecek image'lar listeleniyor..."
        images=$(docker images --format "{{.Repository}}:{{.Tag}}@{{.ID}}")  # <none> filterini kaldÄ±r
        if [[ -z $images ]]; then
            echo "âŒ Silinecek image yok!"
            exit 1
        fi
        formatted=$(echo "$images" | sed 's/@/ - /')
        selected=$(echo "$formatted" | gum choose --no-limit --header "Silinecek image'lar (Space: seÃ§, ctrl+a: tÃ¼mÃ¼):")
        if [[ -n $selected ]]; then
            while IFS= read -r item; do
                [[ -z $item ]] && continue
                image_id=$(echo "$item" | awk '{print $NF}')  # Son field = ID
                echo "ğŸ—‘ï¸ $image_id siliniyor..."
                docker rmi -f "$image_id"
            done <<< "$selected"
            echo "âœ… SeÃ§ilen image'lar silindi"
            docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"  # GÃ¼ncel listeyi gÃ¶ster
        else
            echo "âŒ HiÃ§bir image seÃ§ilmedi"
        fi
        ;;

    up)
        echo "ğŸš€ Servisler baÅŸlatÄ±lÄ±yor..."
        docker compose up -d
        ;;

    upb)
        echo "ğŸ”¨ Build yapÄ±lÄ±yor ve servisler baÅŸlatÄ±lÄ±yor..."
        docker compose up -d --build
        ;;

    reup)
        echo "â™»ï¸ Servisler tamamen yeniden oluÅŸturuluyor..."
        echo "ğŸ›‘ Servisler durduruluyor..."
        docker compose stop
        docker compose down -v --remove-orphans
        docker system prune -f
        echo "â³ Volume'lerin silinmesi bekleniyor..."
        sleep 2
        echo "ğŸš€ Servisler yeniden baÅŸlatÄ±lÄ±yor..."
        docker compose up -d
        ;;

    down)
        echo "ğŸ›‘ Servisler durduruluyor..."
        docker compose down
        ;;

    down-v)
        echo "ğŸ›‘ Servisler durduruluyor ve volumeler siliniyor..."
        docker compose down -v --remove-orphans
        ;;

    restart)
        if [ -z "$2" ]; then
            echo "â™»ï¸ TÃ¼m servisler yeniden baÅŸlatÄ±lÄ±yor..."
            docker compose restart
        else
            echo "â™»ï¸ $2 servisi yeniden baÅŸlatÄ±lÄ±yor..."
            docker compose restart "$2"
        fi
        ;;

    recreate)
    	if [ -n "$2" ]; then
            echo "â™»ï¸ $2 servisi yeniden oluÅŸturuluyor..."
            docker compose up -d --no-deps "$2"
        else
            echo "âš ï¸ LÃ¼tfen yeniden oluÅŸturulacak servisin adÄ±nÄ± girin!"
        fi
        ;;

    nuke)
        echo "ğŸ’£ UYARI: Bu iÅŸlem TÃœM Docker kaynaklarÄ±nÄ± silecek!"
        read -rp "ğŸ”¥ Devam etmek istediÄŸinizden emin misiniz? (yes/NO): " confirm
        if [ "$confirm" = "yes" ]; then
            echo "ğŸ›‘ Servisler durduruluyor..."
            docker compose down -v --remove-orphans 2>/dev/null || true
            echo "ğŸ’¥ TÃ¼m sistem temizleniyor..."
            docker system prune -a --volumes -f
            echo "âœ… Nuke tamamlandÄ± - tÃ¼m containerlar, imajlar ve volume'ler silindi"
        else
            echo "âŒ Ä°ÅŸlem iptal edildi"
        fi
        ;;

    iup)
        services=$(docker compose config --services 2>/dev/null)
        if [[ -z $services ]]; then
            echo "âŒ Compose dosyasÄ± bulunamadÄ±!"
            exit 1
        fi
        selected=$(echo "$services" | gum choose --no-limit --header "BaÅŸlatÄ±lacak servisler (Space: seÃ§, a: tÃ¼mÃ¼):")
        if [[ -n $selected ]]; then
            echo "$selected" | xargs docker compose up -d
            echo "âœ… SeÃ§ilen servisler baÅŸlatÄ±ldÄ±"
        else
            echo "âŒ HiÃ§bir servis seÃ§ilmedi"
        fi
        ;;

    idown)
        services=$(docker compose config --services 2>/dev/null)
        if [[ -z $services ]]; then
            echo "âŒ Compose dosyasÄ± bulunamadÄ±!"
            exit 1
        fi
        selected=$(echo "$services" | gum choose --no-limit --header "KaldÄ±rÄ±lacak servisler (Space: seÃ§, a: tÃ¼mÃ¼):")
        if [[ -n $selected ]]; then
            for svc in $selected; do
                docker compose rm -f -s "$svc" 2>/dev/null
            done
            echo "âœ… SeÃ§ilen servisler kaldÄ±rÄ±ldÄ±"
        else
            echo "âŒ HiÃ§bir servis seÃ§ilmedi"
        fi
        ;;


    build)
        echo "ğŸ”¨ Ä°majlar build ediliyor..."
        docker build
        ;;

    pull)
        echo "ğŸ“¥ Ä°majlar gÃ¼ncelleniyor..."
        docker pull
        ;;

    services)
        echo "ğŸ“‹ Mevcut servisler:"
        docker config --services
        ;;

    vol)
        echo "ğŸ“‹ Mevcut volume'ler:"
        docker volume ls
        ;;

    sh)
        containers=$(docker ps --format "{{.Names}}")
        if [[ -z $containers ]]; then
            echo "âŒ HiÃ§bir Ã§alÄ±ÅŸan container yok!"
            exit 1
        fi

        selected=$(echo "$containers" | gum choose --header "BaÄŸlanÄ±lacak container:")
        if [[ -z $selected ]]; then
            echo "âŒ HiÃ§bir container seÃ§ilmedi"
            exit 1
        fi

        echo "ğŸ”— $selected iÃ§ine baÄŸlanÄ±lÄ±yor..."
        docker exec -it "$selected" bash 2>/dev/null || docker exec -it "$selected" sh
        ;;

    ilogs)
        services=$(docker compose config --services 2>/dev/null)
        if [[ -z $services ]]; then
            echo "âŒ Compose dosyasÄ± bulunamadÄ± veya servis yok!"
            exit 1
        fi

        selected=$(echo "$services" | gum choose --header "LoglarÄ± izlenecek servis:")
        if [[ -z $selected ]]; then
            echo "âŒ HiÃ§bir servis seÃ§ilmedi"
            exit 1
        fi

        mode=$(echo -e "TÃ¼mÃ¼\nSon 100 satÄ±r\nSon 5 dakika\nSon 10 dakika" | gum choose --header "Log gÃ¶rÃ¼ntÃ¼leme modu:")
        if [[ -z $mode ]]; then
            echo "âŒ GÃ¶rÃ¼ntÃ¼leme modu seÃ§ilmedi"
            exit 1
        fi

        case "$mode" in
            "Son 100 satÄ±r")
                echo "ğŸ“„ $selected servis loglarÄ± (son 100 satÄ±r, timestamps, canlÄ± izleme)..."
                docker compose logs -f --tail=100 --timestamps "$selected"
                ;;
            "Son 5 dakika")
                echo "ğŸ“„ $selected servis loglarÄ± (son 5 dk, timestamps, canlÄ± izleme)..."
                docker compose logs -f --since=5m --timestamps "$selected"
                ;;
            "Son 10 dakika")
                echo "ğŸ“„ $selected servis loglarÄ± (son 10 dk, timestamps, canlÄ± izleme)..."
                docker compose logs -f --since=10m --timestamps "$selected"
                ;;
            *)
                echo "ğŸ“„ $selected servis loglarÄ± (tamamÄ±, timestamps, canlÄ± izleme)..."
                docker compose logs -f --timestamps "$selected"
                ;;
        esac
        ;;

    logs)
        if [ -z "$2" ]; then
            echo "âŒ KullanÄ±m: dm logs <servis_adÄ±>"
            echo "ğŸ’¡ Mevcut servisler:"
            docker compose config --services
            exit 1
        fi
        echo "ğŸ“„ $2 servis loglarÄ± izleniyor... (Ã‡Ä±kmak iÃ§in Ctrl+C)"
        # docker compose logs -f "$2"
        docker compose logs "$2"
        ;;

    inspect)
        if [ -z "$2" ]; then
            echo "âŒ KullanÄ±m: dm logs <servis_adÄ±>"
            echo "ğŸ’¡ Girilen servisin IP Adresi:"
            docker inspect -f
            exit 1
        fi
        echo "ğŸ“„ $2 servisinin IP Adresi"
        docker inspect -f "{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}" "$2"
        ;;

    heal)
        if [ -z "$2" ]; then
            echo "âŒ KullanÄ±m: dm heal <servis_adÄ±>"
            echo "ğŸ’¡ Girilen servisin healty saÄŸlÄ±k kontrolÃ¼:"
            docker inspect --format '{{json .State.Health}}' | jq
            exit 1
        fi
        echo "ğŸ“„ $2 servisinin IP Adresi"
        docker inspect "$2" --format '{{json .State.Health}}' | jq
        ;;

    check)
        echo "ğŸ” compose.yaml docker config ile kontrol ediliyor..."
        docker compose config >/dev/null
        if [[ $? -eq 0 ]]; then
            echo "âœ… Dosya geÃ§erli"
        else
            echo "âŒ Syntax hatasÄ± var!"
        fi
        ;;

    check-yaml)
        echo "ğŸ” compose.yaml YAML lint(yamllint) ile kontrol ediliyor..."
        if ! command -v yamllint >/dev/null; then
          echo "â„¹ï¸ yamllint bulunamadÄ±. Kur: pip install yamllint"
        fi
        yamllint -d "{extends: default, rules: {line-length: disable}}" compose.yaml
        ;;

esac
